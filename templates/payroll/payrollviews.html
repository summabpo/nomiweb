{% extends 'base/base.html' %}
{% load crispy_forms_tags %}
{% load custom_filters %}
{% block navbar %}
    {% include 'base/navbar_payroll.html' %}               
{% endblock %}

{% load static %}

{% block title %}
    Nomiweb.co - Aplicación Contable - Nóminas 
{% endblock %}

{% block sub_titulo1 %} 
Nóminas
{% endblock %}

{% block sub_titulo2 %} 
Plantilla de Nóminas - Nomina #{{ nombre.idnomina }}
{% endblock %}

{% block titulo2 %} 
  {{ nombre.nombrenomina }}
{% endblock %}

{% block actions %}
    <!-- Botón para activar modal -->
    <a href="{% url 'payroll:payroll' %}"  class="btn btn-light-primary"   >
        Atras
        <i class="ki-duotone ki-exit-left fs-2 ">             
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
    </a>  

{% endblock %}

{% block content %}


<div class="table-responsive">
    <table id="tabla-contrato-activos" class="table table-striped table-bordered">
        <thead >
            <tr class="fw-bold fs-6 text-gray-800">
                <th class="text-center" >Documento</th>
                <th>Nombre</th>
                <th class="text-center" >Salario</th>
                <th class="text-center" >Gestión</th>
            </tr>
        </thead>
        <tbody>
            {% for empleado in empleados %}
                <tr >
                    <td class="text-center">{{ empleado.idempleado__docidentidad }}</td>
                    <td>{{ empleado.idempleado__papellido }} {{ empleado.idempleado__sapellido }} {{ empleado.idempleado__pnombre }}</td>
                    <td class="text-center">{{ empleado.salario|format_currency }}</td>
                    <td class="text-center">
                        <div class="d-inline-flex">
                            <button class="btn btn-icon btn-sm btn-light-info me-2" data-bs-toggle="modal" data-bs-target="#kt_modal_concept"  data-empleado="{{empleado.idcontrato}}" >
                                <i class="fa-solid fa-file-circle-plus fs-3" data-bs-toggle="tooltip"  data-bs-custom-class="tooltip-inverse" data-bs-placement="top" title="Agregar Concepto"></i>
                            </button>
                            
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Modal para Nuevo concepto - directo de  empleado  -->
<div class="modal fade" tabindex="-1" id="kt_modal_concept">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Concepto</h3>

                <!-- Botón para cerrar -->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Cerrar">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!-- Fin del botón para cerrar -->
            </div>

            <div class="modal-body" id="modal-content-body" >

                <div class="accordion" id="kt_accordion_1">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="kt_accordion_1_header_1">
                            <button class="accordion-button fs-4 fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#kt_accordion_1_body_1" aria-expanded="true" aria-controls="kt_accordion_1_body_1">
                                Datos de la Nómina
                            </button>
                        </h2>
                        <div id="kt_accordion_1_body_1" class="accordion-collapse collapse show" aria-labelledby="kt_accordion_1_header_1" data-bs-parent="#kt_accordion_1">
                            <div class="accordion-body">

                                <p id="salary" class="d-flex justify-content-between" >
                                    <strong>Salario: </strong><span id="salary-value" class="ms-4 ">Valor</span>
                                </p>
                                
                                <p id="income" class="d-flex justify-content-between">
                                    <strong>Ingresos:</strong><span id="income-value" class="ms-4 text-end">Valor</span>
                                </p>
                                
                                <p id="discounts" class="d-flex justify-content-between">
                                    <strong>Descuentos:</strong><span id="discounts-value" class="ms-4 text-end">Valor</span>
                                </p>

                                <p id="summation" class="d-flex justify-content-between">
                                    <strong>Total:</strong><span id="summation-value" class="ms-4 text-end">Valor</span>
                                </p>
                                

                            </div>
                        </div>
                    </div>
                
                    
                
                
                </div>
                <br>
                <form id="form_custom_payroll_concept" method="post" action="{% url 'payroll:payrollviewapi' %}">
                {% csrf_token %}
                    <table id="kt_datatable_example" class="table table-row-bordered table-row-dashed gy-5">
                        <thead>
                            <tr class="fw-semibold fs-6 text-gray-800">
                                <th>Nombre Concepto</th>
                                <th>Cantidad</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" form="form_custom_payroll_concept" id="kt_payroll_concept_submit" name="submit_direct" class="btn btn-primary">Agregar</button>
                
            </div>
        </div>
    </div>
</div>



{% endblock content %}

{% block js %}

<script>
    var formData = new FormData($('#form_custom_payroll_concept')[0]);
    var jsonData = {};
    
    // Convertir FormData en objeto JSON
    formData.forEach(function(value, key) {
        jsonData[key] = value;
    });
    
    $.ajax({
        url: '/contable/payrollapi/', // URL de destino para el POST
        type: 'POST',
        data: JSON.stringify(jsonData),  // Convertir el objeto en una cadena JSON
        contentType: 'application/json', // Especificar el tipo de contenido como JSON
        success: function(response) {
            if (response.success) {
                alert('Concepto agregado exitosamente');
                $('#kt_modal_concept').modal('hide');
                location.reload(); // Recargar la página para mostrar los nuevos datos
            } else {
                alert('Error al agregar el concepto: ' + response.error);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            alert('Ocurrió un error al procesar la solicitud.');
        }
    });
</script>


<script>
    var counter = 2;
    var table = $("#kt_datatable_example").DataTable({
        language: {
            "decimal": "",
            "emptyTable": "No hay datos disponibles en la tabla",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
            "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
            "infoFiltered": "(filtrado de _MAX_ entradas totales)",
            "infoPostFix": "",
            "thousands": ",",
            "lengthMenu": "Mostrar _MENU_ entradas",
            "loadingRecords": "Cargando...",
            "processing": "Procesando...",
            "search": "Buscar:",
            "zeroRecords": "No se encontraron registros coincidentes",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            },
            "aria": {
                "sortAscending": ": activar para ordenar la columna ascendente",
                "sortDescending": ": activar para ordenar la columna descendente"
            }
        },
        order: [],
        dom: 'Bfrtip',
        buttons: [
            {
                text: '<i class="fa-solid fa-square-plus fs-2"></i> Agregar Concepto',
                className: 'btn btn-light-info',
                id: 'kt_datatable_example_addrow',
                action: function (e, dt, node, config) {
                    // No reiniciar la tabla, solo agregar una fila nueva
                    table.row.add([
                        `<select class="form-select form-select-solid" id="row-${counter}-office" name="row-${counter}-office">
                            <option value="Edinburgh">Edinburgh</option>
                            <option value="London">London</option>
                            <option value="New York">New York</option>
                            <option value="San Francisco">San Francisco</option>
                            <option value="Tokyo">Tokyo</option>
                        </select>`,
                        `<input type="text" class="form-control form-control-solid" id="row-${counter}-age" name="row-${counter}-age" value=""/>`,
                        `<input type="text" class="form-control form-control-solid" id="row-${counter}-position" name="row-${counter}-position" value=""/>`
                    ]).draw(false);
                    counter++;  // Incrementar el contador para nuevas filas
                }
            },
        ],
        "pageLength": 5,  
        columns: [
            { title: "Nombre Concepto" },
            { title: "Cantidad" },
            { title: "Valor" }
        ],
        columnDefs: [{
            orderable: false,
            targets: [1, 2]
        }]
    });

    // Agregar datos de la API cuando se abre el modal
    $('#kt_modal_concept').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // El botón que activó el modal
        var nominaId = "{{ nombre.idnomina }}"; 
        var empleadoId = button.data('empleado'); // id de empleado
    
        var modal = $(this);
    
        const url = `/contable/payrollapi/?nomina_id=${nominaId}&empleado_id=${empleadoId}`;
    
        // Limpiar la tabla antes de cargar nuevos datos
        table.clear(); // Limpiar la tabla

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tableBody = modal.find('#kt_datatable_example tbody');
                
                // Limpiar la tabla antes de cargar los nuevos datos de la API
                tableBody.empty(); 
    
                let totalIncome = 0;
                let totalDiscounts = 0;
    
                if (data.error) {
                    tableBody.append(`<tr><td colspan="3">${data.error}</td></tr>`);
                } else {
                    modal.find('.modal-title').text('Conceptos de : ' + data.nombre);
                    modal.find('#salary').html('<strong>Salario:</strong>' + data.salario );
    
                    data.conceptos.forEach(concepto => {
                        if (concepto.monto > 0) {
                            totalIncome += concepto.monto;
                        } else {
                            totalDiscounts += concepto.monto;
                        }

                        // Añadir los datos de la API a la tabla
                        table.row.add([
                            `<input type="text" class="form-control form-control-solid" id="row-${concepto.id}-age" name="row-${concepto.id}-age" value="${concepto.id}"/>`,
                            `<input type="text" class="form-control form-control-solid" id="row-${concepto.id}-position" name="row-${concepto.id}-position" value="${concepto.empleado}"/>`,
                            `<input type="text" class="form-control form-control-solid" id="row-${concepto.id}-monto" name="row-${concepto.id}-monto" value="${concepto.monto}"/>`
                        ]).draw(false);
                    });
    
                    modal.find('#income').html('<strong>Ingresos:</strong> '+ '<div class="text-success" >' + totalIncome.toFixed(2) + ' $' + '</div>');
                    modal.find('#discounts').html('<strong>Descuentos:</strong> '+ '<div class="text-danger" >' + totalDiscounts.toFixed(2) + ' $' + '</div>');
    
                    let total = totalIncome + totalDiscounts;
                    modal.find('#summation').html('<strong>Total:</strong> '+ '<strong>' + total.toFixed(2) + ' $' + '</strong>');
                }
            })
            .catch(error => {
                console.error("Error al obtener los datos:", error);
                modal.find('#kt_datatable_example tbody').html("<tr><td colspan='3'>Error al cargar la información.</td></tr>");
            });
    });
</script>







<script>
    $(document).ready(function() {
        $('#tabla-contrato-activos').DataTable({
            language: {
                "decimal": "",
                "emptyTable": "No hay datos disponibles en la tabla",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                "infoPostFix": "",
                "thousands": ",",
                "lengthMenu": "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros coincidentes",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "aria": {
                    "sortAscending": ": activar para ordenar la columna ascendente",
                    "sortDescending": ": activar para ordenar la columna descendente"
                }
            },
            dom: 'frtip',
            order: [],
            pageLength: 10
        });
    });
</script>
{% endblock %}
