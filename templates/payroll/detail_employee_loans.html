{% extends 'base/base.html' %}
{% load crispy_forms_tags %}
{% block navbar %}
    {% include 'base/navbar_payroll.html' %}               
{% endblock %}

{% load static %} 


{% block title %}
    Nomiweb.co - Aplicacion Contable - Prestamos Empleados
{% endblock %}

{% block sub_titulo1 %} 
<a href="{% url 'payroll:loans_list' %}" class="text-gray-500 text-hover-primary">
    Prestamos Empleados
</a>
{% endblock %}

{% block sub_titulo2 %} 
Detalle nomina
{% endblock %}

{% block sub_titulo3 %} 

{% endblock %}

{% block titulo2 %} 
Información Empleado: {{ employee_info.full_name }}
{% endblock %}

{% block actions %}
<a href="{% url 'payroll:loans_list' %}"  class="btn btn-light-primary"   >
    Atras
    <i class="ki-duotone ki-exit-left fs-2 ">             
        <span class="path1"></span>
        <span class="path2"></span>
    </i>
</a>  
{% endblock %}


{%block content%}
<table id="kt_datatable_dom_positioning" class="table table-striped table-row-bordered gy-5 gs-7 border rounded">
    <thead>
        <tr class="fw-bold fs-6 text-gray-800 px-7">
            <th class="text-center align-middle">Prestamo #</th>
            <th class="text-center align-middle">Fecha Préstamo</th>
            <th class="text-center align-middle">Valor Prestamo</th>
            <th class="text-center align-middle">Cuotas Prestamo</th>
            <th class="text-center align-middle">Estado</th>
            <th class="text-center align-middle">Detalle</th>
        </tr>
    </thead>
    <tbody>
        {% for loan in loans_detail %}
        <tr>
            <td class="text-center align-middle">{{ loan.idprestamo }}</td>
            <td class="text-center align-middle">{{ loan.fechaprestamo|date:"d-M-Y" }}</td>
            <td class="text-center align-middle">{{ loan.valorprestamo }}</td>
            <td class="text-center align-middle ">{{ loan.cuotasprestamo }}</td>
            <td class="text-center align-middle">{{ loan.estadoprestamo }}</td>
            <td class="text-center align-middle">
                <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                    <button type="button" 
                            class="btn btn-icon btn-light-primary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#loanDetailModal"
                            data-loan-id="{{ loan.idprestamo }}"
                            title="Ver Detalle">
                        <i class="fa-regular fa-eye fs-2"></i>
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>    

<!-- Modal -->
<div class="modal fade" tabindex="-1" id="loanDetailModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalle del Préstamo #<span id="loanIdHeader"></span></h3>
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" 
                    data-bs-dismiss="modal" 
                    aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <div id="loanDetailContent">
                    <!-- Contenido dinámico se insertará aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" 
                        class="btn btn-light" 
                        data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block js %}
<script>
    $(document).ready(function() {
        $('#loanDetailModal').on('show.bs.modal', function(event) {
            const button = $(event.relatedTarget);
            const loanId = button.data('loan-id');
            const modal = $(this);
            
            // Limpiar contenido anterior
            modal.find('#loanDetailContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Cargando...</div>');
            modal.find('#loanIdHeader').text(loanId);
    
            // Hacer petición AJAX
            $.ajax({
                url: `/payroll/api/loan-details/${loanId}/`,
                method: 'GET',
                success: function(data) {
                    const tableContent = `
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Nómina ID</th>
                                    <th>Fecha Pago</th>
                                    <th>Valor Deducción</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.details.map(detail => `
                                    <tr>
                                        <td>${detail.nomina_id}</td>
                                        <td>${new Date(detail.fecha_pago).toLocaleDateString()}</td>
                                        <td>$${detail.valor_deduccion.toLocaleString()}</td>
                                        <td>${detail.estado}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Total Pagado:</strong> $${data.total_pagado.toLocaleString()}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Saldo Pendiente:</strong> $${data.saldo_pendiente.toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                    modal.find('#loanDetailContent').html(tableContent);
                },
                error: function() {
                    modal.find('#loanDetailContent').html('<div class="alert alert-danger">Error al cargar los datos</div>');
                }
            });
        });
    });
    </script>

$('#kt_modal_1').on('show.bs.modal', function(event) {
    const button = $(event.relatedTarget);
    const controlId = button.data('control-id');
    fetchPayrollLoanDetails(controlId);
});

<script>
    $("#kt_datatable_dom_positioning").DataTable({
        "language": {
            "lengthMenu": "Mostrar _MENU_",
            "zeroRecords": "No se encontraron resultados",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
            "infoEmpty": "Mostrando 0 a 0 de 0 registros",
            "infoFiltered": "(filtrado de _MAX_ registros totales)",
            "search": "Buscar:",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            },
        },
        "ordering": false,
        "dom":
            "<'row mb-2'" +
            "<'col-sm-6 d-flex align-items-center justify-conten-start dt-toolbar'l>" +
            "<'col-sm-6 d-flex align-items-center justify-content-end dt-toolbar'f>" +
            ">" +
    
            "<'table-responsive'tr>" +
    
            "<'row'" +
            "<'col-sm-12 col-md-5 d-flex align-items-center justify-content-center justify-content-md-start'i>" +
            "<'col-sm-12 col-md-7 d-flex align-items-center justify-content-center justify-content-md-end'p>" +
            ">"
    });
</script>


{% endblock %}